{% extends "layout.html" %}

{% block page_title %}
  Page Title
{% endblock %}

{% block content %}
  <style>
    #map {
      height: 500px;
    }
  </style>

  <main id="content" role="main">
    {% include '../includes/phase_banner_alpha.html' %}

    <div class="grid-row">
      <div class="column-two-thirds">
        <h1 class="heading-xlarge">Take your marriage certificate to your nearest Jobcentre</h1>

        <h2 class="heading-medium">Enter your postcode</h2>

        <form>
          <div class="form-group">
            <label class="form-label label-no-hint visuallyhidden" for="postcode">
              Postcode
            </label>
            <input type="text" name="postcode" class="form-control" id="postcode">
          </div>

          <div class="form-group">
            <input type="submit" class="button" value="Submit">
          </div>
        </form>
      </div>
    </div>

    {% if query %}
      <div class="grid-row">
        <a id="1-mile" href="#">1 mile</a> | <a id="5-miles" href="#">5 miles</a> | <a id="10-miles" href="#">10 miles</a>
        <div id="map">
        </div>
      </div>
    {% endif %}
  </main>
{% endblock %}

{% block page_scripts %}
  {% if query %}
    <script>
      var userPcode = window.location.href.split('?')[1].split('postcode=')[1];
      var pcodeCentre;
      var radius = 50000;
      $.ajax({
        url: "https://api.postcodes.io/postcodes/" + userPcode,
        dataType: "json",
        encode: true,
        success: function(data) {
          pcodeCentre = [parseFloat(data.result.latitude), parseFloat(data.result.longitude)];
          moveToLocation(parseFloat(data.result.latitude), parseFloat(data.result.longitude));
        }
      });

      var map;
      var infowindow;
      var circle1, circle5, circle10;

      function moveToLocation(lat, lng){
        var center = new google.maps.LatLng(lat, lng);
        map.panTo(center);

        circle1 = new google.maps.Circle({
          strokeColor: '#FF0000',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: '#FF0000',
          fillOpacity: 0.35,
          map: map,
          center: {lat: lat, lng: lng},
          radius: 1609.34
        });

        circle5 = new google.maps.Circle({
          strokeColor: '#FF0000',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: '#FF0000',
          fillOpacity: 0.35,
          map: map,
          center: {lat: lat, lng: lng},
          radius: 8046.72
        });

        circle10 = new google.maps.Circle({
          strokeColor: '#FF0000',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: '#FF0000',
          fillOpacity: 0.35,
          map: map,
          center: {lat: lat, lng: lng},
          radius: 16093.4
        });

        circle1.setMap(null);
        circle5.setMap(null);
        circle10.setMap(null);

        infowindow = new google.maps.InfoWindow();
        var service = new google.maps.places.PlacesService(map);
        service.nearbySearch({
          location: center,
          radius: radius,
          keyword: 'jobcentre'
        }, callback);
      }

      $('#1-mile').click(function(e) {
        e.preventDefault();
        circle1.setMap(map);
        circle5.setMap(null);
        circle10.setMap(null);
      });

      $('#5-miles').click(function(e) {
        e.preventDefault();
        circle1.setMap(null);
        circle5.setMap(map);
        circle10.setMap(null);
      });

      $('#10-miles').click(function(e) {
        e.preventDefault();
        circle1.setMap(null);
        circle5.setMap(null);
        circle10.setMap(map);
      });

      function initMap() {
        var circle;
        var user = {lat: 51.5283063, lng: -0.3824716};

        map = new google.maps.Map(document.getElementById('map'), {
          center: user,
          zoom: 13
        });
      }

      function callback(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          for (var i = 0; i < results.length; i++) {
            createMarker(results[i]);
          }
        }
      }

      function createMarker(place) {
        var placeLoc = place.geometry.location;
        var marker = new google.maps.Marker({
          map: map,
          position: place.geometry.location
        });

        google.maps.event.addListener(marker, 'click', function() {
          infowindow.setContent('<div><strong style="font-weight: bold">' + place.name + '</strong>' + '<br />' + place.vicinity + '</div>');
          infowindow.open(map, this);
        });
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBeANre8VZSXSjIbk_pvjLPpNhZDBeXxmk&libraries=places&callback=initMap" async defer></script>
  {% endif %}
{% endblock %}